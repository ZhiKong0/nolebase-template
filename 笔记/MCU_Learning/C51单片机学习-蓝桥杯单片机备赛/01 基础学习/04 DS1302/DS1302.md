## DS1302实时时钟芯片 详细课程总结

### 一、课程基本信息

| 项目 | 内容 |
|------|------|
| **课程** | 第16届蓝桥杯单片机设计与开发 |
| **课时** | 第十课时 |
| **主题** | DS1302实时时钟芯片的应用 |
| **教学重点** | 外设模块通信、SPI协议、BCD编码、时间读写操作 |

---

### 二、DS1302芯片概述

#### 2.1 芯片功能
- **核心功能**：实时时钟芯片，提供年、月、日、星期、时、分、秒的时间数据
- **额外功能**：内置31×8位（31字节）的电池备份RAM，可用于数据存储
- **比赛用途**：蓝桥杯中主要用于读取/显示当前时间

#### 2.2 硬件连接（CT107D开发板）
芯片位于原理图V3E版本，共有8个引脚，其中3个与单片机通信：

| DS1302引脚   | 单片机引脚 | 功能             |
| ---------- | ----- | -------------- |
| **SCK**    | P17   | 串行时钟           |
| **I/O**    | P23   | 数据输入/输出（对应SDA） |
| **CE/RST** | P13   | 芯片使能/复位        |


其他引脚：
- VCC1/VCC2：电源（主电源+备用电池）
- GND：接地
- X1/X2：外接32.768KHz晶振（提供时钟基准）

---

### 三、关键寄存器与标志位

#### 3.1 日历时钟寄存器结构（BCD编码）

```
┌─────────────────────────────────────────────────────┐
│ 寄存器地址  │  功能   │  位定义（从高位到低位）        │
├─────────────────────────────────────────────────────┤
│   80H/81H   │   秒   │  CH │ 秒的十位(0-5) │ 秒的个位 │
│   82H/83H   │   分   │     │ 分的十位(0-5) │ 分的个位 │
│   84H/85H   │   时   │ 12/24位│AM/PM或十位│ 时的个位 │
│   86H/87H   │   日   │     │ 日的十位(0-3) │ 日的个位 │
│   88H/89H   │   月   │     │ 月的十位(0-1) │ 月的个位 │
│   8AH/8BH   │  星期   │     │    000       │ 星期(1-7) │
│   8CH/8DH   │   年   │     │ 年的十位(0-9) │ 年的个位 │
│   8EH/8FH   │  控制   │  WP │      0       │    0    │
└─────────────────────────────────────────────────────┘
```

**注意**：
- **偶数地址**（80H, 82H...）：**写**寄存器地址
- **奇数地址**（81H, 83H...）：**读**寄存器地址

#### 3.2 两个关键标志位

| 标志位 | 位置 | 功能说明 |
|--------|------|----------|
| **CH** (Clock Halt) | 秒寄存器(80H)的第7位 | 时钟停止位：<br>• `1` = 时钟停止，进入低功耗模式<br>• `0` = 时钟运行（必须设为0才能计时） |
| **WP** (Write Protect) | 控制寄存器(8EH)的第7位 | 写保护位：<br>• `1` = 写保护开启，无法写入时间数据<br>• `0` = 写保护关闭，可以写入数据<br>⚠️ **写入时间前必须先将WP置0** |

---

### 四、BCD编码详解（核心知识点）

#### 4.1 什么是BCD编码？
BCD（Binary-Coded Decimal）编码是一种用二进制表示十进制数字的编码方式。**每一位十六进制数字直接对应一位十进制数字**。

#### 4.2 为什么使用BCD编码？
**为了方便写入和读取时间数据**：
- 例如要设置30秒，直接写入十六进制数 `0x30` 即可
- 不需要手动计算十进制30转十六进制是 `0x1E`
- 寄存器内部自动将高4位作为"十位"，低4位作为"个位"

#### 4.3 BCD编码示例

| 时间值 | BCD编码  | 说明                    |
| --- | ------ | --------------------- |
| 30秒 | `0x30` | 3→十位，0→个位             |
| 45分 | `0x45` | 4→十位，5→个位             |
| 22时 | `0x22` | 2→十位，2→个位             |
| 09日 | `0x09` | ⚠️ 必须写`0x09`，不能写`0x9` |
![[Pasted image 20260222222437.png]]
#### 4.4 重要转换公式

**BCD → 十进制**（读取时转换）：
```c
// 十六进制0x35 → 十进制35
十位 = (bcd_value / 16) * 10;   // 0x35/16 = 3, 3*10 = 30
个位 = bcd_value % 16;          // 0x35%16 = 5
十进制值 = 十位 + 个位;          // 30 + 5 = 35
```

**十进制 → BCD**（设置时间时转换）：
```c
// 十进制35 → BCD编码0x35
bcd_value = (decimal / 10) * 16 + (decimal % 10);
// 35/10=3, 3*16=48; 35%10=5; 48+5=53=0x35
```

---

### 五、代码实现步骤

#### 5.1 官方驱动文件引入
蓝桥杯官方资源包（BSP文件夹）提供 `ds1302.c` 和 `ds1302.h`，包含两个核心函数：
```c
void Write_Ds1302(unsigned char address, unsigned char dat);  // 写操作
unsigned char Read_Ds1302(unsigned char address);             // 读操作
```

#### 5.2 引脚定义（sbIT关键字）
```c
sbit SCK = P1^7;   // 时钟线
sbit SDA = P2^3;   // 数据线（对应IO）
sbit RST = P1^3;   // 复位/使能（对应CE）
```

#### 5.3 完整操作流程

**第一步：定义寄存器地址数组**
```c
// 写寄存器地址（偶数）：秒、分、时、日、月、周、年
unsigned char code WRITE_ADDR[7] = {0x80, 0x82, 0x84, 0x86, 0x88, 0x8A, 0x8C};

// 读寄存器地址（奇数）
unsigned char code READ_ADDR[7] = {0x81, 0x83, 0x85, 0x87, 0x89, 0x8B, 0x8D};
```

**第二步：定义初始时间（BCD编码）**
```c
unsigned char TIME_INIT[7] = {
    0x55,  // 秒：55秒
    0x42,  // 分：42分
    0x22,  // 时：22时（24小时制，第7位为0）
    0x09,  // 日：9号
    0x02,  // 月：2月
    0x07,  // 星期：周日
    0x25   // 年：25年（2025年）
};
```

**第三步：写入初始时间函数**
```c
void DS1302_WriteTime(void) {
    // 1. 关闭写保护（WP=0）
    Write_Ds1302(0x8E, 0x00);
    
    // 2. 依次写入7个时间数据
    for(i = 0; i < 7; i++) {
        Write_Ds1302(WRITE_ADDR[i], TIME_INIT[i]);
    }
    
    // 3. 开启写保护（WP=1），防止干扰
    Write_Ds1302(0x8E, 0x80);
}
```

**第四步：读取时间函数**
```c
unsigned char TIME_READ[7];  // 存储读取结果（十进制）

void DS1302_ReadTime(void) {
    for(i = 0; i < 7; i++) {
        unsigned char bcd = Read_Ds1302(READ_ADDR[i]);  // 读取BCD值
        // BCD转十进制
        TIME_READ[i] = (bcd / 16) * 10 + (bcd % 16);
    }
}
```

#### 5.4 主函数调用流程
```c
void main() {
    // 系统初始化
    System_Init();
    
    // 1. 设置初始时间（只需执行一次）
    DS1302_WriteTime();
    
    while(1) {
        // 2. 循环读取当前时间
        DS1302_ReadTime();
        
        // 3. 数码管显示（时-分-秒）
        // 时分秒分别对应 TIME_READ[2], TIME_READ[1], TIME_READ[0]
        Display_Time();
    }
}
```

---

### 六、12小时制 vs 24小时制

时寄存器(84H)的第7位控制小时模式：

| 第7位 | 模式 | 第5位含义 |
|-------|------|-----------|
| `0` | 24小时制 | 时的十位（0-2） |
| `1` | 12小时制 | AM/PM标志（0=AM，1=PM） |

**推荐使用24小时制**，设置时确保第7位为0：
```c
0x22  // 22时，24小时制（第7位为0）
```

---

### 七、关键注意事项

1. **BCD编码写入**：写入时间时必须使用十六进制表示，如55秒写`0x55`而非十进制55
2. **0x09 vs 0x9**：单个数字前面要补0，如9号必须写`0x09`
3. **WP写保护**：写入数据前必须先关闭写保护（写0x00到0x8E），写完后再开启
4. **CH时钟启动**：确保秒寄存器第7位(CH)为0，时钟才能运行
5. **数组声明**：存储时间的数组需要声明为`extern`，才能在多个文件中使用
6. **HEX文件生成**：必须勾选"Create HEX File"选项才能生成可烧录文件

---

### 八、课后练习建议

课程建议完成以下练习以巩固知识：
1. **基础练习**：实现DS1302实时时钟在数码管上显示（时-分-秒）
2. **进阶练习**：结合矩阵按键实现时间的设置与修改功能（进入设置模式→调整数值→保存退出）